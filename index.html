<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <canvas id="canvas" width="1000" height="600" style="background-color: mediumturquoise"></canvas>
    <script>
      /* Get the canvas object */
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const gravity = 0.4; 
      const gameObjects = [];
      const colliderGroup = [];

      /* Images */
      class MainCharacter {
        constructor(x = 100, y = 350, width = 90, height = 90) {
          this.x = x;
          this.y = y;
          this.state = "normal";
          this.width = width;
          this.height = height;
          this.vy = 0 // 加速度
          this.image = new Image();
          this.image.src = "./assets/images/chara1.png";

          gameObjects.push(this)
        }

        jump() {
          if (this.state === "jump") {
            // ジャンプ中にジャンプはできない
            return;
          }
          this.vy = -16
          this.state = "jump";
        }

        collidion(stone) {
          // distant
          let distX = Math.abs(this.x - stone.x);
          let distY = Math.abs(this.y - stone.y);
          if(distX < 50 && distY < 80) {
            console.log("ぶつかった！")
            // 衝突したオブジェクトが、障害物かニンジンか判定する
          }
        }

        update() {
          if(this.state === "jump"){
            this.y = this.y + this.vy;
            this.vy = this.vy + 0.9;
            if(this.y > 350){
              // 着地したらjumpステート終了
              this.y = 350
              this.state = "normal"
            }
          }
          ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
          
          // 当たっているかの判定
          colliderGroup.forEach(obstacle => {
            this.collidion(obstacle)
          })
        }
      }

      class Stone {
        constructor(x = 900, y = 380, width = 60, height = 60) {
          this.x = x;
          this.y = y;
          this.speed = 8;
          this.width = width;
          this.height = height;
          this.image = new Image();
          this.image.src = "./assets/images/stone.png";
          gameObjects.push(this)
          colliderGroup.push(this)
        }

        update() {
          this.x -= this.speed;
          if (this.x < 0) {
            this.x = 1000;
          }
          ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
        }
      }

      /* GameObject */
      function init() {
        const chara = new MainCharacter();
        const stone1 = new Stone(900);
        const stone2 = new Stone(1250);
        const stone3 = new Stone(1600);
        const stone4 = new Stone(2000);

        /* ジャンプ */
        canvas.onclick = (event) => {
          chara.jump();
        };
      }

      // 初期化
      function gameStart(){
        init()
      }

      gameStart()

      /* メインループ */
      setInterval(() => {
        ctx.fillRect(0, 0, 1000, 600);
        gameObjects.forEach(obj => {
          obj.update()
        })
      }, 33); // 30fps frame per seconds
    </script>
  </body>
</html>
