<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
</head>

<body>
  <canvas id="canvas" width="1000" height="600" style="background-color: black"></canvas>
  <button onclick="gameStart()">スタート</button>
  <script>
    /* Get the canvas object */
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const gameObjects = [];
    const colliderGroup = [];
    const invaderGroup = [];
    const LEFT = 'left';
    const RIGHT = 'right';
    let MainThreadId = null
    let bullet = null
    class Chara {
      constructor(x = 100, y = 350, width = 45, height = 45) {
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
        this.image = new Image();
        this.image.src = "./assets/images/3.png";
        this.image.onload = () => {
          this.draw();
        };
        gameObjects.push(this);
      }
      draw() {
        ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
      }
      update(type) {
        ctx.clearRect(this.x, this.y, 45, 45);
        if (type === 'left') {
          this.x = this.x - 15
        }
        if (type === 'right') {
          this.x = this.x + 15
        }
        ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
      }
      shot() {
        new Bullet(this.x)
      }
    }
    class Bullet {
      constructor(x = 475, y = 450, width = 40, height = 80) {
        this.x = x;
        this.y = y;
        this.speed = 5;
        this.width = width;
        this.height = height;
        this.image = new Image();
        this.image.src = "./assets/images/4.png";
        gameObjects.push(this)
      }
      draw() {
        ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
      }
      update() {
        this.y -= this.speed;
        if (this.y < 0) {
          this.y = -150;
        }
        ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
        // // 当たっているかの判定
        invaderGroup.forEach(obj => {
          this.collision(obj)
        })
      }
      // 敵にあたっていないかチェック
      collision(obj) {
        let distX = Math.abs(this.x - obj.x);
        let distY = Math.abs(this.y - obj.y);

        if (distX < 50 && distY < 50) {
          console.log('当たった')
          // 弾を消す
          this.x = 1000
          // 敵を消す
          obj.x = 1000
        }
      }
    }
    class Invader {
      constructor(x = 100, y = 350, width = 45, height = 45) {
        this.x = x;
        this.y = y;
        this.setPositionX = x
        this.moveSpeed = 4
        this.width = width;
        this.height = height;
        this.image = new Image();
        this.image.src = "./assets/images/1.png";
        this.image.onload = () => {
          this.appear();
        };
        invaderGroup.push(this)
        gameObjects.push(this);
      }
      // 初回描画
      appear() {
        ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
      }
      // ゲーム進行中の描画
      update() {
        this.x += this.moveSpeed
        if (this.setPositionX - this.x < -25 || this.setPositionX - this.x > 25) {
          this.moveSpeed = this.moveSpeed * -1
        }
        ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
      }
    }
    for (let i = 0; i < 9; i++) {
      for (let j = 0; j < 4; j++) {
        new Invader(75 + 100 * i, 50 + 100 * j);
      }
    }
    const chara = new Chara(475, 500)
    document.onkeydown = (event) => {
      // 左
      if (event.keyCode === 37) {
        chara.update(LEFT)
      }
      // 右
      if (event.keyCode === 39) {
        chara.update(RIGHT)
      }
      // スペース
      if (event.keyCode === 32) {
        chara.shot();
      }
    }
    // フレームの制御
    function gameStart() {
      MainThreadId = setInterval(() => {
        // 1フレームごとに処理すべきことはこの中に書く
        ctx.clearRect(0, 0, 1000, 600)
        gameObjects.forEach(obj => {
          // GameObjectの描画処理と、判定処理などはupdateの中に書く
          obj.update()
        })
      }, 33)
    }
    function puase() {
      clearInterval(MainThreadId)
    }
    function restart() {
      gameStart()
    }
  </script>
</body>

</html>